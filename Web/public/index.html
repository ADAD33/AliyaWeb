<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aliya_测试</title>
    <link rel="stylesheet" href="./CSS/web.css">
</head>
<body style="background-color: rgb(35, 35, 35); margin: 0;">
    
    <!--整体布局-->
    <div class="box">
        <div class="information-box">
            <div class="player">
                <!-- 调整容器结构，确保正确的层级关系 -->
                <div class="wait-box">
                    <div class="wait">
                        <!-- PlayerChoice图片作为背景 -->
                        <img id="wait" src="./system/wait/PlayerChoice.png" alt="选择器背景图">
                        <!-- 动画容器 - 将在图片内部居中 -->
                        <div id="wait_anmation"></div>
                    </div>
                </div> 
            </div>
        </div>
        <div class="nav-box">
        </div>

        <div id="chat-container">
            <div id="chat-box">
                <div class="typing-indicator" id="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="向Aliya发送消息..." autocomplete="off">
                <button id="send-btn" onclick="sendMessage()">发送</button>
            </div>
        </div>
    </div>

<!-- 动画脚本放在body底部，确保DOM加载完成 -->
<!-- <script src="./JS/wait.js"></script> -->

<!-- 添加位置调整脚本 -->
<script src="./JS/position-adjust.js"></script>

<!-- 核心聊天功能脚本 -->
<script>
// 获取DOM元素
const userInputEl = document.getElementById('user-input');
const chatBoxEl = document.getElementById('chat-box');
const sendBtnEl = document.getElementById('send-btn');
const typingIndicator = document.getElementById('typing-indicator');

// 让输入框支持按回车发送
userInputEl.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// 生成唯一的会话ID
function generateSessionId() {
    return 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}

// 从本地存储获取或创建会话ID
function getOrCreateSessionId() {
    let sessionId = localStorage.getItem('chatSessionId');
    if (!sessionId) {
        sessionId = generateSessionId();
        localStorage.setItem('chatSessionId', sessionId);
    }
    return sessionId;
}

// 创建会话信息显示元素
function createSessionInfoElement() {
    const infoElement = document.createElement('div');
    infoElement.id = 'session-info';
    infoElement.style.cssText = `
        text-align: center; 
        color: black; 
        margin: 10px 0; 
        font-size: 14px;
        opacity: 0.8;
    `;
    document.getElementById('chat-container').insertBefore(infoElement, document.getElementById('input-area'));
    return infoElement;
}

// 更新会话信息显示
function updateSessionInfo(messageCount, tokens) {
    const infoElement = document.getElementById('session-info') || createSessionInfoElement();
    infoElement.innerHTML = `
        对话轮次: ${messageCount} | 
        估算Token: ${tokens} |
        <button onclick="clearSession()" style="margin-left: 10px; background: rgba(255, 255, 255, 0.1); color: black; border: 1px solid black; border-radius: 12px; padding: 4px 12px; cursor: pointer; font-size: 12px; transition: all 0.3s ease;">清空对话</button>
    `;
}

// 清空会话功能
async function clearSession() {
    const sessionId = getOrCreateSessionId();
    
    try {
        const response = await fetch(`/api/session/${sessionId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // 生成新的会话ID
            const newSessionId = generateSessionId();
            localStorage.setItem('chatSessionId', newSessionId);
            
            // 清空聊天显示（保留第一条欢迎消息）
            const chatBox = document.getElementById('chat-box');
            const welcomeMessage = chatBox.querySelector('.ai-message');
            chatBox.innerHTML = '';
            if (welcomeMessage) {
                const containerDiv = document.createElement('div');
                containerDiv.classList.add('message-container', 'ai-container');
                containerDiv.appendChild(welcomeMessage);
                chatBox.appendChild(containerDiv);
            }
            
            // 重置会话信息
            updateSessionInfo(1, 0);
            
            appendMessage('ai', '对话已重置，我们可以重新开始聊天了！', false);
        }
    } catch (error) {
        console.error('清空会话失败:', error);
        appendMessage('ai', '清空对话时出现了问题，请稍后重试。', false);
    }
}

// 核心函数：发送消息到后端API
async function sendMessage() {
    const userMessage = userInputEl.value.trim();
    if (!userMessage) return;

    // 禁用按钮和输入框，防止重复发送
    sendBtnEl.disabled = true;
    userInputEl.disabled = true;

    const sessionId = getOrCreateSessionId();

    // 将用户消息立即显示在聊天框中
    appendMessage('user', userMessage, false);
    userInputEl.value = ''; // 清空输入框
    
    // 显示输入指示器
    typingIndicator.style.display = 'block';
    chatBoxEl.scrollTop = chatBoxEl.scrollHeight;

    try {
        // 使用fetch API向我们的后端服务器发送POST请求
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                message: userMessage,
                sessionId: sessionId
            })
        });

        // 首先检查响应状态
        if (!response.ok) {
            const errorText = await response.text();
            console.error('错误响应内容:', errorText);
            
            if (response.status === 405) {
                throw new Error(`方法不被允许 (405)。请检查：\n1. 后端服务器是否重启\n2. 路由是否正确定义\n3. 是否有其他服务器占用端口`);
            }
            throw new Error(`HTTP错误! 状态码: ${response.status}`);
        }

        // 检查响应内容类型
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('接收到非JSON响应:', text.substring(0, 500));
            throw new Error('服务器返回了非JSON格式的响应');
        }

        // 现在安全地解析JSON
        const data = await response.json();
        console.log('成功接收到响应:', data);

        // 处理AI回复 - 按反斜线分割成多条消息
        processAIResponse(data.reply);
        
        // 更新会话信息
        if (data.messageCount && data.estimatedTokens) {
            updateSessionInfo(data.messageCount, data.estimatedTokens);
        }
        
    } catch (error) {
        console.error('请求失败:', error);
        // 向用户显示友好的错误信息
        appendMessage('ai', `❌ 请求失败: ${error.message}`, false);
    } finally {
        // 无论成功失败，都重新启用按钮和输入框
        sendBtnEl.disabled = false;
        userInputEl.disabled = false;
        userInputEl.focus(); // 让输入框重新获得焦点
        
        // 隐藏输入指示器
        typingIndicator.style.display = 'none';
    }
}

// 处理AI回复，按反斜线分割成多条消息
function processAIResponse(reply) {
    // 检查回复中是否包含反斜线
    if (reply.includes('/')) {
        // 按反斜线分割回复
        const parts = reply.split('/').filter(part => part.trim() !== '');

        // 为每个部分添加轻微延迟，创造更自然的对话流
        parts.forEach((part, index) => {
            setTimeout(() => {
                appendMessage('ai', part.trim(), index > 0);
            }, index * 1000); // 每条消息间隔1秒
        });
    } else {
        // 如果没有反斜线，直接显示整个回复
        appendMessage('ai', reply, false);
    }
}

// 辅助函数：将消息追加到聊天框
function appendMessage(sender, text, isContinued) {
    // 创建消息容器
    const containerDiv = document.createElement('div');
    containerDiv.classList.add('message-container');
    containerDiv.classList.add(sender === 'user' ? 'user-container' : 'ai-container');
    
    // 创建消息气泡
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
    messageDiv.textContent = text;
    
    // 如果是连续消息，调整样式
    if (isContinued) {
        messageDiv.style.marginTop = '-8px';
    }
    
    // 将消息气泡添加到容器
    containerDiv.appendChild(messageDiv);
    
    // 将容器添加到聊天框
    chatBoxEl.appendChild(containerDiv);

    // 确保输入指示器在底部
    chatBoxEl.appendChild(typingIndicator);
    
    // 自动滚动到底部
    chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
}

// 在页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化会话信息显示
    createSessionInfoElement();
    updateSessionInfo(0, 0);
    
    // 添加欢迎消息
    setTimeout(() => {
        appendMessage('ai', '嗨COSMOS，好久不见', false);
        updateSessionInfo(1, 0);
    }, 500);
});
    </script>
</body>
</html>
